<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>‚ú® Smart Mirror Voice Assistant ‚ú®</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>

    <h2>‚ú® Smart Mirror Voice Assistant ‚ú®</h2>

    <div class="button-row">
        <button id="startBtn">‚ñ∂Ô∏è Start Recording</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop Recording</button>
        <button id="stopSpeakBtn" disabled>üîá Stop Speaking</button>
    </div>

    <p id="status"></p>

    <div class="card">
        <p><b>You asked:</b> <span id="transcript" class="transcript-text"></span></p>
        <p><b>Mirror's Answer:</b> <span id="answer" class="answer-text"></span></p>
    </div>

    <script>
        let mediaRecorder;
        let chunks = [];
        let utterance;

        // AsigurƒÉ-te cƒÉ vocile sunt √ÆncƒÉrcate √Æn fundal pentru iOS
        speechSynthesis.getVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = speechSynthesis.getVoices;
        }

        function cleanText(text) {
            if (!text) return "";
            text = text.replace(/[*_`~#]/g, "");
            text = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF])/g, "");
            text = text.replace(/[\/\\]/g, "");
            text = text.replace(/\s{2,}/g, " ");
            return text.trim();
        }

        function setFemaleVoice(utterance) {
            let voices = speechSynthesis.getVoices();
            // CƒÉutƒÉm Samantha (standard pe iPhone) sau orice voce femininƒÉ de englezƒÉ
            let femaleVoice = voices.find(v => v.name.includes("Samantha") || v.name.includes("Female"));

            // DacƒÉ nu gƒÉse»ôte dupƒÉ nume, alege prima voce de englezƒÉ disponibilƒÉ
            if (!femaleVoice) {
                femaleVoice = voices.find(v => v.lang.startsWith("en"));
            }

            if (femaleVoice) {
                utterance.voice = femaleVoice;
                utterance.lang = femaleVoice.lang;
            }
        }

        document.getElementById("startBtn").onclick = async () => {
            try {
                // ACTIVARE SUNET iPHONE: Un sunet mut care "deschide" canalul audio
                const wakeup = new SpeechSynthesisUtterance("");
                speechSynthesis.speak(wakeup);

                if (speechSynthesis.speaking) speechSynthesis.cancel();

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                chunks = [];

                // LƒÉsƒÉm Safari sƒÉ decidƒÉ formatul optim (mp4/aac)
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);

                mediaRecorder.onstop = async () => {
                    document.getElementById("status").innerText = "‚ú® Mirror is thinking...";

                    let blob = new Blob(chunks, { type: "audio/mp4" });
                    let formData = new FormData();
                    formData.append("audio", blob, "voice.mp4");

                    try {
                        let response = await fetch("/voice", { method: "POST", body: formData });
                        let data = await response.json();

                        if (data.error) {
                            document.getElementById("status").innerText = "Error: " + data.error;
                            return;
                        }

                        let cleanedAnswer = cleanText(data.answer);
                        document.getElementById("transcript").innerText = data.transcript;
                        document.getElementById("answer").innerText = cleanedAnswer;
                        document.getElementById("status").innerText = "‚ú® Done!";

                        // PregƒÉtire Voce
                        utterance = new SpeechSynthesisUtterance(cleanedAnswer);
                        setFemaleVoice(utterance);

                        // Parametri optimi pentru claritate
                        utterance.volume = 1;
                        utterance.rate = 0.9; // Pu»õin mai lent pentru un efect magic
                        utterance.pitch = 1.1; // Pu»õin mai feminin

                        speechSynthesis.speak(utterance);
                        document.getElementById("stopSpeakBtn").disabled = false;

                    } catch (err) {
                        document.getElementById("status").innerText = "Error: " + err;
                    }

                    document.getElementById("startBtn").disabled = false;
                    document.getElementById("stopBtn").disabled = true;
                };

                mediaRecorder.start();
                document.getElementById("status").innerText = "‚ú® Recording...";
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopBtn").disabled = false;

            } catch (err) {
                alert("Microphone error: " + err);
            }
        };

        document.getElementById("stopBtn").onclick = () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        };

        document.getElementById("stopSpeakBtn").onclick = () => {
            speechSynthesis.cancel();
            document.getElementById("stopSpeakBtn").disabled = true;
        };
    </script>
</body>

</html>