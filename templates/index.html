<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>‚ú® Smart Mirror Voice Assistant ‚ú®</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>

<body>

    <h2>‚ú® Smart Mirror Voice Assistant ‚ú®</h2>

    <div class="button-row">
        <button id="startBtn">‚ñ∂Ô∏è Start Recording</button>
        <button id="stopBtn" disabled>‚èπÔ∏è Stop Recording</button>
        <button id="stopSpeakBtn" disabled>üîá Stop Speaking</button>
    </div>

    <p id="status"></p>

    <div class="card">
        <p><b>You asked:</b> <span id="transcript" class="transcript-text"></span></p>
        <p><b>Mirror's Answer:</b> <span id="answer" class="answer-text"></span></p>
    </div>

    <script>
        let mediaRecorder;
        let chunks = [];
        let utterance;

        // CurƒÉ»õƒÉ textul de caractere speciale »ôi emoji
        // CurƒÉ»õƒÉ textul de caractere speciale, emoji »ôi Markdown (#, *, _, /, \, etc.)
        function cleanText(text) {
            // DacƒÉ textul este null sau undefined, returneazƒÉ un »ôir gol
            if (!text) return "";

            text = text.replace(/[*_`~#]/g, "");
            text = text.replace(/([\u2700-\u27BF]|[\uE000-\uF8FF]|[\uD83C-\uDBFF\uDC00-\uDFFF])/g, "");
            text = text.replace(/[\/\\]/g, "");
            text = text.replace(/\s{2,}/g, " ");
            return text.trim();
        }


        // Voce femininƒÉ
        function setFemaleVoice(utterance) {
            let voices = speechSynthesis.getVoices();
            const femaleVoice = voices.find(v => v.name.includes("Female") || v.name.includes("Samantha") || v.name.includes("Amelie"));
            if (femaleVoice) utterance.voice = femaleVoice;
        }

        // START RECORDING
        document.getElementById("startBtn").onclick = async () => {
            try {
                // Opre»ôte orice TTS curent
                if (speechSynthesis.speaking) speechSynthesis.cancel();

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                chunks = [];

                mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/mp4" });
                mediaRecorder.ondataavailable = e => chunks.push(e.data);

                mediaRecorder.onstop = async () => {
                    document.getElementById("status").innerText = "‚ú® Mirror is thinking...";

                    let blob = new Blob(chunks, { type: "audio/mp4" });
                    let formData = new FormData();
                    formData.append("audio", blob, "voice.mp4");

                    try {
                        let response = await fetch("/voice", { method: "POST", body: formData });
                        let data = await response.json();

                        if (data.error) {
                            document.getElementById("status").innerText = "Error from server: " + data.error;
                            return; // Opre»ôte execu»õia dacƒÉ avem eroare de la Python
                        }

                        let cleanedAnswer = cleanText(data.answer);
                        // ... restul codului

                        document.getElementById("transcript").innerText = data.transcript;
                        document.getElementById("answer").innerText = cleanedAnswer;
                        document.getElementById("status").innerText = "‚ú® Done!";

                        // TTS cu voce femininƒÉ
                        utterance = new SpeechSynthesisUtterance(cleanedAnswer);
                        setFemaleVoice(utterance);
                        speechSynthesis.speak(utterance);
                        document.getElementById("stopSpeakBtn").disabled = false;

                    } catch (err) {
                        document.getElementById("status").innerText = "Error: " + err;
                    }

                    document.getElementById("startBtn").disabled = false;
                    document.getElementById("stopBtn").disabled = true;
                };

                mediaRecorder.start();
                document.getElementById("status").innerText = "‚ú® Recording...";
                document.getElementById("startBtn").disabled = true;
                document.getElementById("stopBtn").disabled = false;

            } catch (err) {
                alert("Microphone error: " + err);
            }
        };

        // STOP RECORDING
        document.getElementById("stopBtn").onclick = () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
                document.getElementById("status").innerText = "‚ú® Stopping...";
            }
        };

        // STOP SPEAKING
        document.getElementById("stopSpeakBtn").onclick = () => {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
                document.getElementById("stopSpeakBtn").disabled = true;
                document.getElementById("status").innerText = "‚ú® Speaking stopped.";
            }
        };
    </script>

</body>

</html>